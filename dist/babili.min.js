!function(){"use strict";var a=null,b=null,c=angular.module("babili",["ngResource"]);c.provider("babili",function(){this.options={apiUrl:"babili-api",socketUrl:"",aliveInterval:3e4,fetchUserFunction:null},this.configure=function(a){this.options=_.extend(this.options,a)},this.$get=["$q","$interval","$http","$rootScope",function(d,e,f,g){_.forEach(this.options,function(a,b){c.constant(b,a)});var h=this.options.aliveInterval,i=angular.injector(["babili"]),j=function(a,b){return function(c){a.roomWithId(c.roomId).then(function(d){void 0!==d&&null!==d?b.$apply(function(){d.messages.push(c)}):i.get("BabiliRoom").get({id:c.roomId}).$promise.then(function(b){a.rooms.push(b),d=b}),a.hasRoomOpened(d).then(function(a){a||g.$apply(function(){d.unreadMessageCount=d.unreadMessageCount+1})})})}};return{headers:function(){var b={};return b["x-babili-token"]=a,b},token:function(){return a},connect:function(c,f){a=f;var g=d.defer();return i.get("BabiliMe").get().$promise.then(function(a){i.get("babiliSocket").initialize(function(b,d){d.on("new message",j(a,c))});var d=function(){i.get("BabiliAlive").save({})};d(),b=e(d,h),g.resolve(a)})["catch"](function(a){g.reject(a)}),g.promise},disconnect:function(){var c=d.defer();return a=null,e.cancel(b),i.get("babiliSocket").disconnect().then(function(){c.resolve()}),c.promise},update:function(b,c){a=c;var e=d.defer();return i.get("BabiliMe").get().$promise.then(function(a){b.rooms.length!==a.rooms.length&&a.rooms.forEach(function(a){b.rooms.some(function(b){return b.id===a.id})||b.rooms.push(a)}),e.resolve()}),e.promise}}}]})}(),function(){"use strict";angular.module("babili").factory("BabiliAlive",["$resource","babili","apiUrl",function(a,b,c){return a(c+"/client/alive",{},{save:{method:"POST",headers:b.headers()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliMe",["$resource","$q","babili","apiUrl","BabiliRoom","BabiliMessage",function(a,b,c,d,e,f){var g=a(d+"/client/me",{},{get:{method:"GET",headers:c.headers(),transformResponse:function(a){var b=angular.fromJson(a);return b.rooms&&(b.rooms=b.rooms.map(function(a){return new e(a)})),b}}});return g.prototype.roomWithId=function(a){var c=b.defer(),d=_.find(this.rooms,function(b){return b.id===a});return c.resolve(d),c.promise},g.prototype.hasRoomOpened=function(a){var c=b.defer();return a&&a.id?c.resolve(_.includes(this.openedRoomIds,a.id)):c.reject(new Error("Room need to be defined.")),c.promise},g.prototype.openRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a).then(function(b){b?d.resolve():e.open({id:a.id}).$promise.then(function(){c.openedRoomIds.push(a.id),a.markAllMessageAsRead(),d.resolve(a)})}),d.promise},g.prototype.closeRoom=function(a){var c=this,d=b.defer();return c.hasRoomOpened(a).then(function(b){b?e.close({id:a.id}).$promise.then(function(){_.remove(c.openedRoomIds,function(b){return b===a.id}),d.resolve(a)}):d.resolve()}),d.promise},g.prototype.closeRooms=function(a){var c=this,d=a.map(function(a){return c.closeRoom(a)});return b.all(d)},g.prototype.openRoomAndCloseOthers=function(a){var b=this,c=b.rooms.filter(function(b){return b.id!==a.id});return b.closeRooms(c).then(function(){return b.openRoom(a)})},g.prototype.hasOpenedRooms=function(){var a=b.defer();return a.resolve(!_.isEmpty(this.openedRoomIds)),a.promise},g.prototype.openedRooms=function(){var a=this,c=b.defer(),d=_.filter(a.rooms,function(b){return _.includes(a.openedRoomIds,b.id)});return c.resolve(d),c.promise},g.prototype.createRoom=function(a,c){var d=this,f=b.defer(),g=new e({name:a,userIds:c.concat(d.id)});return e.save(g).$promise.then(function(a){return d.roomWithId(a.id).then(function(b){b?f.resolve(b):(d.rooms.push(a),f.resolve(a))})})["catch"](function(a){f.reject(a)}),f.promise},g.prototype.updateRoomName=function(a){var c=this,d=b.defer();return a.update().then(function(b){var e=_.findIndex(c.rooms,function(b){return a.id===b.id});c.rooms[e].name=b.name,d.resolve()})["catch"](function(a){d.reject(a)}),d.promise},g.prototype.addUserToRoom=function(a,b){return this.roomWithId(a.id).then(function(a){return a.addUser(this,b)})},g.prototype.sendMessage=function(a,c){var d=b.defer(),e=this;return c&&c.content?a?f.save({roomId:a.id},c).$promise.then(function(b){return e.roomWithId(a.id).then(function(a){a.messages.push(b),d.resolve(b)})})["catch"](function(a){d.reject(a)}):d.reject(new Error("Room need to be defined.")):d.resolve(null),d.promise},g.prototype.messageSentByMe=function(a){var c=b.defer();return c.resolve(a&&this.id===a.senderId),c.promise},g.prototype.deleteMessage=function(a){var c=b.defer(),d=this;return a?f["delete"]({id:a.id,roomId:a.roomId}).$promise.then(function(){return d.roomWithId(a.roomId).then(function(b){var d=_.findIndex(b.messages,function(b){return b.id===a.id});b.messages.splice(d,1),c.resolve()})})["catch"](function(a){c.reject(a)}):c.resolve(null),c.promise},g}])}(),function(){"use strict";angular.module("babili").factory("BabiliMembership",["$resource","babili","apiUrl",function(a,b,c){return a(c+"/client/rooms/:roomId/memberships/:id",{membershipId:"@membershipId",id:"@id"},{save:{method:"POST",headers:b.headers()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliMessage",["$resource","babili","apiUrl",function(a,b,c){return a(c+"/client/rooms/:roomId/messages/:id",{roomId:"@roomId",id:"@id"},{save:{method:"POST",headers:b.headers()},get:{method:"GET",headers:b.headers()},query:{method:"GET",isArray:!0,headers:b.headers()},"delete":{method:"delete",headers:b.headers()}})}])}(),function(){"use strict";angular.module("babili").factory("BabiliRoom",["$resource","babili","$q","apiUrl","BabiliMessage","BabiliMembership",function(a,b,c,d,e,f){var g=a(d+"/client/rooms/:id",{id:"@id"},{save:{method:"POST",headers:b.headers()},get:{method:"GET",headers:b.headers()},update:{method:"PUT",headers:b.headers()},"delete":{method:"DELETE",headers:b.headers()},read:{url:d+"/client/rooms/:id/read",params:{id:"@id"},method:"POST",headers:b.headers()},open:{url:d+"/client/rooms/:id/open",params:{id:"@id"},method:"POST",headers:b.headers()},close:{url:d+"/client/rooms/:id/open",params:{id:"@id"},method:"DELETE",headers:b.headers()}});return g.prototype.markAllMessageAsRead=function(){var a=this,b=c.defer();return a.unreadMessageCount>0?g.read({id:this.id}).$promise.then(function(){a.unreadMessageCount=0,b.resolve(!0)}):b.resolve(!1),b.promise},g.prototype.addUser=function(a,b){var d=c.defer(),e=this;return f.save({roomId:e.id},{userId:b},function(a){e.users.push(a.user),d.resolve()},function(a){d.reject(a)}),d.promise},g.prototype.update=function(){var a=c.defer(),b={name:this.name};return g.update({id:this.id},b,function(b){a.resolve(b)},function(b){a.reject(b)}),a.promise},g}])}(),function(){"use strict";angular.module("babili").factory("babiliSocket",["babili","socketUrl","$q",function(a,b,c){var d,e={initialize:function(c){d=io.connect(b,{query:"token="+a.token()}),d.on("connect",function(){c(null,d)})},disconnect:function(){var a=c.defer();return d.disconnect(function(){a.resolve()}),a.promise}};return e}])}();